
function fpca(NUMEXPS_OUTDIR=NUMEXPS_OUTDIR_DEFAULT)
    Tf = Float64
    function quick_load_matrices()
    """
    load the matrices A and B from the saved files
    """
    save_dir = "C:\\Users\\wuyoujia\\Desktop\\data_process\\saved_matrices\\"
    
    file_A = joinpath(save_dir, "A_matrix.txt")
    file_B = joinpath(save_dir, "B_matrix.txt")
    
    if !isfile(file_A) || !isfile(file_B)
        error("矩阵文件不存在，请先运行quick_save_matrices()")
    end
    
    A = readdlm(file_A, Float64)
    B = readdlm(file_B, Float64)
    
    println("矩阵加载完成:")
    println("  A: $(size(A))")
    println("  B: $(size(B))")
    
    return A[1:200, 1:200], B[1:200, 1:200]
end

    function MaxQuadFPCA(Tf = Float64)

    n =200
    k = 200
    As = [zeros(Tf, n, n) for i in 1:k]
    bs = [zeros(Tf, n) for i in 1:k]
    ##default Credit
    #As[1]=[99.39728651345489 -8.641874912479139 7.205217109622523 -11.418967743016228 -12.82202915117671 -11.761596244512553 -10.054742201885674 -9.39567675720398 -8.742403613235144 11.693933254021948 10.506454819462228 10.286818903105193 11.235541295561998 11.397514370577678 11.469591379416679 7.565172698556752 8.844227413988468 8.40956438709454 8.277418638282253 9.06394937330966 9.17362011469501; -8.641874912479139 105.54317834557165 -25.540326442618294 1.062725610188703 1.0444243318313724 1.5141981888105187 1.6248056732546028 1.4378202857659161 1.2617566913299687 -1.0178761457023637 -0.6121784443682832 -1.1612097558607548 -0.9628343119044438 -1.5295225786469546 -1.4141253650355992 -0.5478934035844473 -0.39171950750775736 -0.15396215459097587 -0.9450020705985849 -0.478317151703494 -0.45851845526841917; 7.205217109622523 -25.540326442618294 105.52157690628471 -0.8889063468275568 -1.569619515313088 -1.924919460992595 -1.2823779220653362 -1.2351232959071614 -1.306083349269023 2.5485399709240224 2.4970641222600127 2.7845970136761284 2.329657776417663 2.1513568802238945 2.0116180619593154 0.6191855126153533 0.6469407871074246 0.5958964570436076 -0.11456958439327132 0.594149060868177 0.1689906769131988; -11.418967743016228 1.062725610188703 -0.8889063468275568 95.74757625855537 31.969622541104325 21.92176247926411 18.92518510710177 17.183320136078493 15.750656203692436 5.166807778947003 4.929867125193161 4.425516498825986 3.893790813608884 4.362362181548373 4.400867586417633 -3.9869204890103767 -4.029540979612488 -2.9577903427426 -2.52745533798644 -2.412260476674846 -2.3925137590640335; -12.82202915117671 1.0444243318313724 -1.569619515313088 31.969622541104325 88.22642582218134 35.656893843266175 24.11021768196338 21.49384802776696 18.977488996650408 7.078296701394372 6.076742441182715 5.211688325739151 4.744131807744378 4.9634113721404995 4.923696750468304 -5.584136308873602 -3.2874441552486315 -2.5426525826077992 -1.2540435098030398 -1.3153495081229445 -0.9493520626756133; -11.761596244512553 1.5141981888105187 -1.924919460992595 21.92176247926411 35.656893843266175 85.69875512173135 35.49575010267045 25.518700791670668 23.31436228841682 3.8504163219524807 6.112248895046303 5.275008671475456 4.811877611082656 4.792992627164498 4.957456413627491 1.0814625492290326 -5.356722662493643 -2.4476337763776868 -1.6949179297910377 -0.9259052419547029 -1.1837167657485579; -10.054742201885674 1.6248056732546028 -1.2823779220653362 18.92518510710177 24.11021768196338 35.49575010267045 83.89908306043749 38.82114107527317 29.023885836116914 2.9385683143702286 4.396239194939312 6.317101032022595 5.9035756879060735 5.438890474960192 5.482770190388966 -0.5842057326041699 0.9976697663198658 -5.020765270747848 -1.7028149655723477 -1.0501878927498731 -0.8783599237058373; -9.39567675720398 1.4378202857659161 -1.2351232959071614 17.183320136078493 21.49384802776696 25.518700791670668 38.82114107527317 83.69250486908399 40.557953259270064 3.1139679569982173 3.9460202969348623 5.3155069111552224 7.5746600149030865 7.312211484381165 6.862902478312331 -0.40640646321260543 0.2900568440369947 1.2916658620949184 -3.7854690416795513 -1.0033283393631613 -1.2200032248875665; -8.742403613235144 1.2617566913299687 -1.306083349269023 15.750656203692436 18.977488996650408 23.31436228841682 29.023885836116914 40.557953259270064 88.83665346362142 2.9501752735942697 3.7384238183408987 5.114946445708891 6.645713419037025 9.219956860905835 9.312946647749357 -0.23238811498515388 -0.4074457003194693 0.1257732876918675 1.47830230205374 -2.661004327013523 -1.397125389471574; 11.693933254021948 -1.0178761457023637 2.5485399709240224 5.166807778947003 7.078296701394372 3.8504163219524807 2.9385683143702286 3.1139679569982173 2.9501752735942697 72.46594082054672 48.0854074138563 37.92976691505616 31.357842152993143 28.547211276229817 26.81717839868228 1.1284873653588623 1.922554535487845 3.7441490498729086 4.601575574643385 5.449487494881103 5.881906996624284; 10.506454819462228 -0.6121784443682832 2.4970641222600127 4.929867125193161 6.076742441182715 6.112248895046303 4.396239194939312 3.9460202969348623 3.7384238183408987 48.0854074138563 65.43761799225832 42.664353370763365 34.30648674302712 30.67435738369892 29.154728148692133 13.277790976743633 -1.5285100958790243 2.3416219034525803 3.0871521718544193 4.441606166960308 5.174763657252093; 10.286818903105193 -1.1612097558607548 2.7845970136761284 4.425516498825986 5.211688325739151 5.275008671475456 6.317101032022595 5.3155069111552224 5.114946445708891 37.92976691505616 42.664353370763365 64.41706935101223 40.139963078131764 34.169698903537586 31.784869941448775 9.478590298201881 16.118644055810552 -1.0798223583524014 2.214880805527722 4.315295236894145 5.594591191514031; 11.235541295561998 -0.9628343119044438 2.329657776417663 3.893790813608884 4.744131807744378 4.811877611082656 5.9035756879060735 7.5746600149030865 6.645713419037025 31.357842152993143 34.30648674302712 40.139963078131764 65.07163378211271 41.2058569071308 37.300946104616195 7.708680827513511 10.532714731798615 15.741754034987677 -0.21712819288391097 3.5174764321912186 5.616171737086525; 11.397514370577678 -1.5295225786469546 2.1513568802238945 4.362362181548373 4.9634113721404995 4.792992627164498 5.438890474960192 7.312211484381165 9.219956860905835 28.547211276229817 30.67435738369892 34.169698903537586 41.2058569071308 65.06310241623417 47.41248803942527 6.002108490412809 6.886734070144574 9.453695114198787 14.91905614968233 0.9526827627270709 4.076827569106383; 11.469591379416679 -1.4141253650355992 2.0116180619593154 4.400867586417633 4.923696750468304 4.957456413627491 5.482770190388966 6.862902478312331 9.312946647749357 26.81717839868228 29.154728148692133 31.784869941448775 37.300946104616195 47.41248803942527 69.36205836123635 5.1374306127630485 5.413041827182496 7.073308519003646 10.891920439727201 16.216887093952895 0.37409233137931186; 7.565172698556752 -0.5478934035844473 0.6191855126153533 -3.9869204890103767 -5.584136308873602 1.0814625492290326 -0.5842057326041699 -0.40640646321260543 -0.23238811498515388 1.1284873653588623 13.277790976743633 9.478590298201881 7.708680827513511 6.002108490412809 5.1374306127630485 105.64788273941168 7.364465394963442 8.10643309749649 6.030601320320154 6.205387971313774 5.892161275731368; 8.844227413988468 -0.39171950750775736 0.6469407871074246 -4.029540979612488 -3.2874441552486315 -5.356722662493643 0.9976697663198658 0.2900568440369947 -0.4074457003194693 1.922554535487845 -1.5285100958790243 16.118644055810552 10.532714731798615 6.886734070144574 5.413041827182496 7.364465394963442 105.179816201423 8.116978167589274 4.662068972370398 5.303819373850286 8.058160243018445; 8.40956438709454 -0.15396215459097587 0.5958964570436076 -2.9577903427426 -2.5426525826077992 -2.4476337763776868 -5.020765270747848 1.2916658620949184 0.1257732876918675 3.7441490498729086 2.3416219034525803 -1.0798223583524014 15.741754034987677 9.453695114198787 7.073308519003646 8.10643309749649 8.116978167589274 105.2368257105861 7.015505008398878 6.962571445906134 7.472957484543901; 8.277418638282253 -0.9450020705985849 -0.11456958439327132 -2.52745533798644 -1.2540435098030398 -1.6949179297910377 -1.7028149655723477 -3.7854690416795513 1.47830230205374 4.601575574643385 3.0871521718544193 2.214880805527722 -0.21712819288391097 14.91905614968233 10.891920439727201 6.030601320320154 4.662068972370398 7.015505008398878 105.84184148840261 7.498697332909549 6.664369014381094; 9.06394937330966 -0.478317151703494 0.594149060868177 -2.412260476674846 -1.3153495081229445 -0.9259052419547029 -1.0501878927498731 -1.0033283393631613 -2.661004327013523 5.449487494881103 4.441606166960308 4.315295236894145 3.5174764321912186 0.9526827627270709 16.216887093952895 6.205387971313774 5.303819373850286 6.962571445906134 7.498697332909549 105.93215606357003 7.027442947348968; 9.17362011469501 -0.45851845526841917 0.1689906769131988 -2.3925137590640335 -0.9493520626756133 -1.1837167657485579 -0.8783599237058373 -1.2200032248875665 -1.397125389471574 5.881906996624284 5.174763657252093 5.594591191514031 5.616171737086525 4.076827569106383 0.37409233137931186 5.892161275731368 8.058160243018445 7.472957484543901 6.664369014381094 7.027442947348968 106.77123091437466]
    #As[2]=[124.86216001843819 -3.0111339692106878 7.802018973627127 -13.794149777914013 -15.169429082295203 -13.893379030761494 -12.803362316777864 -11.798172621030504 -12.421699351552274 11.874990460418584 10.806652656373833 10.915664294700353 11.999770334222404 12.467924676343122 11.550572030055315 8.453599373732414 6.753446824153098 9.604184069639842 9.613164023296127 11.211189319160052 11.934748418668311; -3.0111339692106878 131.83126273831638 -26.74780283352534 -0.24303098149739086 -0.20261386326912423 0.6044299933397952 0.6197628908925676 1.1021357509609586 1.3682906466138374 -0.3476475753343776 -0.4637849928711386 -0.5994393929640108 -0.5233506713009229 -0.3991205423753274 0.1313508825558159 0.46075828159753546 -0.06994124122280868 0.6034201956489977 0.0862192831684505 1.0866844177484651 0.3929989790382429; 7.802018973627127 -26.74780283352534 131.43142305476283 -2.11968337782385 -2.847341932260089 -2.652098044487507 -2.5839005870772938 -3.4688039863675675 -2.6883231558144427 1.596465553906795 1.415017074882252 1.142717166742015 1.0913933351225436 1.0580837715723828 1.0829152758673872 1.0199548216498986 0.6125273115590507 1.4157988347553303 1.0576513381635657 0.7441155353046572 0.6795825126580741; -13.794149777914013 -0.24303098149739086 -2.11968337782385 118.78685319030761 36.95086502500557 25.992463534338167 23.677706684077442 21.50489076241756 19.885334010672594 7.507945721212227 7.2386568609762385 6.1444033817000765 6.199931577083157 6.345964515172609 6.0967762366381955 -4.800276722176538 -3.3011524716084577 -3.953486099349029 -3.667519733563056 -3.174797212882001 -3.294701175539812; -15.169429082295203 -0.20261386326912423 -2.847341932260089 36.95086502500557 108.36345950151666 43.47368719256619 30.6756471780016 28.28108357203544 25.600151924932366 10.416969150104554 9.367634396774065 7.895327677412817 7.561582952929371 7.255193642483473 7.620944882616196 -5.378818104562904 -2.56675763281514 -2.4821900033687463 -2.4724959009810474 -1.2942756234417845 -1.6199331947407103; -13.893379030761494 0.6044299933397952 -2.652098044487507 25.992463534338167 43.47368719256619 105.99959648795294 42.76707759252947 31.985399711567243 28.67265625485225 7.154707664966789 9.770576426222476 8.722962399414364 7.885004909445836 7.4755622009301135 7.438868388222263 1.6845680387850062 -4.032996500980984 -2.70691192974257 -2.4563483941542867 -1.6664342164317156 -1.8713634085641278; -12.803362316777864 0.6197628908925676 -2.5839005870772938 23.677706684077442 30.6756471780016 42.76707759252947 103.05883781901346 47.426965299395405 35.76552701468281 6.700195111975551 7.721879943029437 9.472951546142074 9.448450299628801 8.414028416445932 8.515696439164957 -0.03502445085051692 1.0133165507004218 -4.831162208552083 -2.2581394122632505 -1.568698371921021 -0.9879275419671529; -11.798172621030504 1.1021357509609586 -3.4688039863675675 21.50489076241756 28.28108357203544 31.985399711567243 47.426965299395405 102.50338182137499 48.979061685753685 6.27072504523655 7.089848558016005 8.199385164510876 11.025920081516523 10.645947818641998 9.742559313514255 -0.4269851322797453 0.03020715325446233 1.9677169090886695 -4.798134231038018 -1.9747003841067443 -0.6181326637862226; -12.421699351552274 1.3682906466138374 -2.6883231558144427 19.885334010672594 25.600151924932366 28.67265625485225 35.76552701468281 48.979061685753685 108.71682648791436 6.251844925379776 7.134717457097423 7.84318871348451 9.600121900087641 12.350519924327518 12.548985024912138 -0.46688189906543187 -0.31415174228755793 0.7903903605339011 2.80491340916162 -3.617843473710669 -1.2802420400375363; 11.874990460418584 -0.3476475753343776 1.596465553906795 7.507945721212227 10.416969150104554 7.154707664966789 6.700195111975551 6.27072504523655 6.251844925379776 88.17737782816153 58.039862673153614 45.365563869853766 40.83708350226838 36.90410473455778 34.94636717253788 -0.8577378496829449 -1.7017089142380912 5.106849589892563 5.968805156118318 6.001923690086892 8.593162946280007; 10.806652656373833 -0.4637849928711386 1.415017074882252 7.2386568609762385 9.367634396774065 9.770576426222476 7.721879943029437 7.089848558016005 7.134717457097423 58.039862673153614 80.3606603747608 50.823243456745224 43.08607442699873 39.14696144422056 37.46596974092126 17.170242570300697 -2.97767988494741 2.9015841398303364 3.546643558450541 4.0937301632930385 7.217295741051507; 10.915664294700353 -0.5994393929640108 1.142717166742015 6.1444033817000765 7.895327677412817 8.722962399414364 9.472951546142074 8.199385164510876 7.84318871348451 45.365563869853766 50.823243456745224 80.0099757043667 49.17869998487147 42.45370732500669 39.0074342885267 8.658255548571686 24.878596573890007 -2.249799416245314 2.066160849176043 6.874748507209736 7.742331580422923; 11.999770334222404 -0.5233506713009229 1.0913933351225436 6.199931577083157 7.561582952929371 7.885004909445836 9.448450299628801 11.025920081516523 9.600121900087641 40.83708350226838 43.08607442699873 49.17869998487147 78.6746450253708 53.10573591549238 45.521795992661126 8.577479205056939 6.151241294551226 17.450752378341733 -1.2094008887015961 3.416300186082999 7.1341422424336844; 12.467924676343122 -0.3991205423753274 1.0580837715723828 6.345964515172609 7.255193642483473 7.4755622009301135 8.414028416445932 10.645947818641998 12.350519924327518 36.90410473455778 39.14696144422056 42.45370732500669 53.10573591549238 79.5482479396286 55.288678235991824 7.201493416655466 4.374589852558297 11.058160986306914 18.143511676138505 0.08596798413424578 6.681310370858311; 11.550572030055315 0.1313508825558159 1.0829152758673872 6.0967762366381955 7.620944882616196 7.438868388222263 8.515696439164957 9.742559313514255 12.548985024912138 34.94636717253788 37.46596974092126 39.0074342885267 45.521795992661126 55.288678235991824 86.63889817388495 5.605079087941089 4.197876893527341 10.07014067359246 11.612795907197196 20.82244838016975 0.34696431954379037; 8.453599373732414 0.46075828159753546 1.0199548216498986 -4.800276722176538 -5.378818104562904 1.6845680387850062 -0.03502445085051692 -0.4269851322797453 -0.46688189906543187 -0.8577378496829449 17.170242570300697 8.658255548571686 8.577479205056939 7.201493416655466 5.605079087941089 128.18062403500608 20.106195437575288 16.675772658176367 12.784967200920901 6.7003283407476975 11.607664056377821; 6.753446824153098 -0.06994124122280868 0.6125273115590507 -3.3011524716084577 -2.56675763281514 -4.032996500980984 1.0133165507004218 0.03020715325446233 -0.31415174228755793 -1.7017089142380912 -2.97767988494741 24.878596573890007 6.151241294551226 4.374589852558297 4.197876893527341 20.106195437575288 127.79266640349645 16.368376675360246 11.779295402881935 11.541459525954277 7.051530897843383; 9.604184069639842 0.6034201956489977 1.4157988347553303 -3.953486099349029 -2.4821900033687463 -2.70691192974257 -4.831162208552083 1.9677169090886695 0.7903903605339011 5.106849589892563 2.9015841398303364 -2.249799416245314 17.450752378341733 11.058160986306914 10.07014067359246 16.675772658176367 16.368376675360246 128.6000631231911 14.026676013956557 7.433068701223136 7.461631733943415; 9.613164023296127 0.0862192831684505 1.0576513381635657 -3.667519733563056 -2.4724959009810474 -2.4563483941542867 -2.2581394122632505 -4.798134231038018 2.80491340916162 5.968805156118318 3.546643558450541 2.066160849176043 -1.2094008887015961 18.143511676138505 11.612795907197196 12.784967200920901 11.779295402881935 14.026676013956557 129.72353960579167 6.254098862492359 8.463348606221464; 11.211189319160052 1.0866844177484651 0.7441155353046572 -3.174797212882001 -1.2942756234417845 -1.6664342164317156 -1.568698371921021 -1.9747003841067443 -3.617843473710669 6.001923690086892 4.0937301632930385 6.874748507209736 3.416300186082999 0.08596798413424578 20.82244838016975 6.7003283407476975 11.541459525954277 7.433068701223136 6.254098862492359 130.626057596639 8.286524971590687; 11.934748418668311 0.3929989790382429 0.6795825126580741 -3.294701175539812 -1.6199331947407103 -1.8713634085641278 -0.9879275419671529 -0.6181326637862226 -1.2802420400375363 8.593162946280007 7.217295741051507 7.742331580422923 7.1341422424336844 6.681310370858311 0.34696431954379037 11.607664056377821 7.051530897843383 7.461631733943415 8.463348606221464 8.286524971590687 131.47624386328144]
    ##LSAC
    #As[1]=[106.94584402219981 51.34897295651033 3.264723463238409 0.04475978485709223 -10.362475360893264 -0.44189034939934524 4.2790943985323295 12.846222580376889 6.996324356162681 13.290191237256465 16.45354114467441; 51.34897295651033 108.51380221453427 0.04955457946179526 -1.3808938501747883 -9.557470671737631 -1.971037796885646 2.351592047901791 10.125199734599967 8.961721809586445 11.857665575834462 5.825100909922492; 3.264723463238409 0.04955457946179526 119.7240154315027 14.634162088974232 1.581311974811781 2.9227202067054696 11.520700841518483 3.131942769893822 8.464757813056801 5.950869454787239 7.259278717577143; 0.04475978485709223 -1.3808938501747883 14.634162088974232 120.284973918111 1.6148409484808937 0.2118941995582873 4.8592856552837125 4.076230488946444 6.692950457700792 6.010965582071598 7.9780487985285795; -10.362475360893264 -9.557470671737631 1.581311974811781 1.6148409484808937 118.90688988375078 5.435253546376636 -10.515381801612428 -12.50686637481941 -6.415867040016977 -12.780438155053025 -5.317635442735906; -0.44189034939934524 -1.971037796885646 2.9227202067054696 0.2118941995582873 5.435253546376636 114.4595113821502 3.9776279981138485 24.45010743557863 18.592716356311794 27.411298445925222 4.255955980662231; 4.2790943985323295 2.351592047901791 11.520700841518483 4.8592856552837125 -10.515381801612428 3.9776279981138485 120.04379973697658 8.92512961050906 -1.1097633001404974 6.83910650391333 5.220022593272747; 12.846222580376889 10.125199734599967 3.131942769893822 4.076230488946444 -12.50686637481941 24.45010743557863 8.92512961050906 90.67593800896596 -0.5005544733392522 73.80369384383995 8.647616027655893; 6.996324356162681 8.961721809586445 8.464757813056801 6.692950457700792 -6.415867040016977 18.592716356311794 -1.1097633001404974 -0.5005544733392522 110.86333673220145 44.05280340198122 2.5744469954562086; 13.290191237256465 11.857665575834462 5.950869454787239 6.010965582071598 -12.780438155053025 27.411298445925222 6.83910650391333 73.80369384383995 44.05280340198122 77.90150481636891 8.090154791463581; 16.45354114467441 5.825100909922492 7.259278717577143 7.9780487985285795 -5.317635442735906 4.255955980662231 5.220022593272747 8.647616027655893 2.5744469954562086 8.090154791463581 119.291676592833]
    #As[2]=[93.71063520479589 45.29658945637357 0.5264657774088194 -0.9452219831509049 -11.345362877909123 -3.3361322124825206 3.691777997147661 13.501156211215438 9.990492851755665 14.880190279190128 13.615349109216714; 45.29658945637357 95.01857969246129 -1.5289881085716381 -0.969275936702408 -10.548577797449145 -3.6864581340952585 3.267968100088232 11.0100349493527 11.183879035543265 13.245113589749018 6.011327629653935; 0.5264657774088194 -1.5289881085716381 106.26508033091437 12.727354558305908 3.9230775097235053 3.8651201403249753 8.856642084702068 4.206072017554738 5.054714139962479 5.345969980411466 6.2882275414074265; -0.9452219831509049 -0.969275936702408 12.727354558305908 106.68156068652031 1.9096244103906832 1.2834142595259832 3.66284102815925 4.575472587523981 3.9730508570247496 5.257595558193676 7.010955675472143; -11.345362877909123 -10.548577797449145 3.9230775097235053 1.9096244103906832 104.48406270951472 4.511472552303689 -8.662327524641395 -11.956766945223537 -8.663791262648187 -13.110806534220508 -3.9680699667005683; -3.3361322124825206 -3.6864581340952585 3.8651201403249753 1.2834142595259832 4.511472552303689 102.94530095712794 3.3090180854073092 20.04520478603371 11.946235330116526 21.037046860693646 4.4244608594387955; 3.691777997147661 3.267968100088232 8.856642084702068 3.66284102815925 -8.662327524641395 3.3090180854073092 106.45513834137688 8.437788041501491 -1.7406942868215067 6.379856185927804 5.2176431078098595; 13.501156211215438 11.0100349493527 4.206072017554738 4.575472587523981 -11.956766945223537 20.04520478603371 8.437788041501491 79.08051214276581 1.3038396622778685 66.23580714843594 8.734506007597028; 9.990492851755665 11.183879035543265 5.054714139962479 3.9730508570247496 -8.663791262648187 11.946235330116526 -1.7406942868215067 1.3038396622778685 98.93293780899364 37.262458226043094 3.4720059780954045; 14.880190279190128 13.245113589749018 5.345969980411466 5.257595558193676 -13.110806534220508 21.037046860693646 6.379856185927804 66.23580714843594 37.262458226043094 68.70437039173122 8.532795030832697; 13.615349109216714 6.011327629653935 6.2882275414074265 7.010955675472143 -3.9680699667005683 4.4244608594387955 5.2176431078098595 8.734506007597028 3.4720059780954045 8.532795030832697 105.560838662652]
    ##LFW
    #As[1],As[2]=quick_load_matrices()
    for l = 1:k
       for i in 1:n, j in i + 1:n
           As[l][i, j] = n
            As[l][j, i] = As[l][i, j]
       end
       for i in 1:n
           As[l][i, i] = l+sum(abs(As[l][i, m]) for m = 1:n) - abs(As[l][i, i])
            # last term dispensable since As are intialized as null
       end
    end
    return MaxQuadPb{Tf}(n, k,-As, bs, zeros(k))
end
    
    pb =MaxQuadFPCA(Tf)
    
    x=rand(Tf, pb.n)
    #x =ones(Tf, pb.n)
    #x=LinearAlgebra.normalize(x)
    #optimal_condition=[1.0]  
    #x = LinearAlgebra.normalize(x + 1e0 * randn(Tf, size(x)))
    #x_iterat
    f_history=[]
    #while optimal_condition[end]>=1e-6

        x=LinearAlgebra.normalize(x)

        optparams_precomp = OptimizerParams(;
            iterations_limit=5,trace_length=0, time_limit=500
        )

        ## Define solvers to be run on problem
        optimdata = DataStructures.OrderedDict()
        time_limit = 500
        
        # nsBFGS
        #o = NSBFGS{Tf}(; ϵ_opt=1e-15)
        #optparams = OptimizerParams(; iterations_limit=700, trace_length=50, time_limit)
        #_ = NSS.optimize!(pb, o, x; optparams=optparams_precomp)
        #xfinal_nsbfgs, tr = NSS.optimize!(pb, o, x; optparams)
        #optimdata[o] = tr


        # Local Newton method
        getx(o, os, optimstate_additionalinfo) = deepcopy(os.x)
        getγ(o, os, optimstate_additionalinfo) = deepcopy(os.γ)
        optimstate_extensions = OrderedDict{Symbol,Function}(:x => getx, :γ => getγ)

        # find the smaller γ which gives maximal structure
        gx = sort(g(pb, x))
      
        γ = 0.0
        for i in 1:(length(gx)-1)
            γ += (gx[end - i + 1] - gx[end - i]) * i
        end

        o = LocalCompositeNewtonOpt{Tf}()
        optparams = OptimizerParams(; iterations_limit=40, trace_length=50, time_limit)
        _ = NSS.optimize!(pb, o, x; optparams=optparams_precomp)
        state = initial_state(o, x, pb; γ)
        xfinal_localNewton, tr = NSS.optimize!(
            pb, o, x; state, optparams, optimstate_extensions
        )
        optimdata[o] = tr

        ## Build figures
        xopt = xfinal_localNewton
        Mopt = MaxQuadManifold(pb, [1])
        Fopt = prevfloat(F(pb, xopt))

        #@show xopt
        #buildfigures(optimdata, tr, pb, xopt, Mopt, Fopt, "FPCA"; NUMEXPS_OUTDIR)
        #xopt = xfinal_localNewton
        #x_start=x
        for os in tr[1:end]
            push!(f_history,-os.Fx)
        end
        print(f_history,"\n")
        #    x = os.additionalinfo.x
        #    push!(x_iterate,x)
        #end     
        #push!(optimal_condition,norm(x_start-xopt)/norm(x))
        # @show xopt
        #x=xopt 

    # 
        #ENV["PLOTSOPTIM_USELATEX"] = false  
        
    
    #end
  
    #||x_k-x*||
    #dist = [norm(x_iterate[i] - x_iterate[end])+1e-16 for i in 1:length(x_iterate)]
    
    #print(dist,"\n")
    #print("xopt:",x_iterate[end])
    return true
end

